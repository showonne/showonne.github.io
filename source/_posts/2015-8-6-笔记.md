title: 2015.8.6 笔记
date: 2015-08-06 22:25:15
tags: [Node.js, 代码优化]
---

在公司实习了有一个月了，期间给公司的打卡系统增改了一些功能，功能都不难，没遇到什么技术难题就完成了，不过经过leader审批时才发现自己写的代码还是有很多问题的，也给了我一些指点。
<!--more-->
#### 1.让代码保持整洁，测试用的语句记得删除，不要仅仅是注释掉。####
因为自己平时写代码比较随意，基本功也不扎实，所以总是依赖`console`来进行校验，验证完也总忘记删除，或是直接注释掉就不管了，这很影响代码的整洁性。

#### 2.中间件的最佳实践，避免大材小用，没有必要就不要用####
比如`eventproxy`模块，是一个利用事件机制解耦复杂逻辑的模块，可以将串行等待变成并行等待，以用来移除`callback 陷阱`.
用法：

    var eventproxy = require('eventproxy');
    var eq = new eventproxy();
    //所有的e1,e2,e3都完成时才会触发eq.all中的逻辑
    eq.all('e1', 'e2', 'e3', function(data1, data2, data3){
      //do something
    });
    function(){
      //do something
      eq.emit('e1');
    }
    function(){
      //do something
      eq.emit('e2');
    }
    function(){
      //do something
      eq.emit('e3');
    }

这样就解决了**深度嵌套**的问题，没错，他要解决的就是**深度嵌套**的问题，然而我在实际中在一个只需要一层嵌套的地方也使用了`eventproxy`(好像是因为初次记使用这个模块就想试试怎么用)，显然不合适。

#### 3.M层不要用来实现具体功能，交给C去做。####
MVC都已经被说烂听烂了，就是将逻辑，数据与视图分离。V层专注视图渲染，C层控制逻辑，M层负责操作数据。**但是M层应该如何操作数据呢？**我写的功能中涉及到了一张叫做`log`的日志表，其中的`status`字段是用来判断这条日志有没有被看过，要设计的功能就是看过每条log之后，将status设置为0，于是我写了一个`changeLogStatus`方法，对应的数据库操作`UPDATE logs SET status = ? WHERE ...`，我当时感觉没什么问题，但是这里有一个很大的问题就是C和M并没有很好地分离开，**M只应该负责对数据的处理，而且这里的处理应该是基本的，是对数据的增删改查，而不应该负责怎样增，删，改哪里**。而我的这条SQL则指定了要改log的`status`，使这条SQL有了具体的功能，所以并没有真正地做到M与C的分离。
正确的处理方法是：对应操作log的SQL方法应该有一个专注于对log的读取，一个专注于对log的更新，然后在Controller中先将要改的数据取到，修改完，再塞回去，看上去仿佛用了两步才完成一个功能，不如直接写一个具体SQL修改来得快，但是对于后续的扩展(也许后面就有对log的其他字段的其他更改呢)就很方便，否则多一个功能可能就要多一条SQL语句，很不利于扩展。

END